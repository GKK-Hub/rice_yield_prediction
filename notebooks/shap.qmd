---
title: "SHAP Analysis"
format:
  html:
    smooth-scroll: true
    encoding: utf-8
    toc: true
    toc-location: right
    toc-depth: 3
    toc-title: Chapters
    theme: zephyr
    # monofont: "JetBrains Mono"
    page-layout: full
    code-tools: true
    include-in-header: 
      text: |
        <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap" rel="stylesheet">
        <style>
          code, pre {
            font-family: 'JetBrains Mono', monospace !important;
          }
        </style>
        <meta charset="UTF-8">
execute:
  enabled: true
  echo: true
  output: true
server: shiny
jupyter: python3

---

In this notebook, we will do SHAP analysis on the best model that we obtained by hyperparameter optimiztion using Optuna Framework.

# Chapter 10: SHAP Analysis

```{python}
import pandas as pd
from rice_yield.utils.paths import get_data_dir

data_dir = get_data_dir("final")
X_train = pd.read_csv(data_dir/"X_train.csv")
X_val = pd.read_csv(data_dir/"X_val.csv")

train_df = pd.concat([X_train, X_val], axis=0)
train_df
```


```{python}
import shap
import joblib
from rice_yield.utils.paths import get_output_dir
from rice_yield.utils.notebook_utils import load_model

best_model_path = get_output_dir()/"best_model/rf.joblib"
best_model = load_model(best_model_path)
best_model
```


```{python}
preprocessor = best_model.named_steps['preprocessor']
estimator = best_model.named_steps['randomforest']

X_train_preprocessed = preprocessor.transform(train_df).toarray()

estimator
```

```{python}
#| output: false
feature_names = preprocessor.get_feature_names_out()
# masker = shap.maskers.Independent(X_train_preprocessed)
# background_data = shap.sample(X_train_preprocessed, 100)  # Sample 100 points
explainer = shap.Explainer(estimator.predict, X_train_preprocessed, feature_names=feature_names)

shap_values = explainer(X_train_preprocessed)
```

```{python}
import matplotlib.pyplot as plt
plt.style.use('fivethirtyeight')

fig_summary, ax_summary = plt.subplots(figsize=(10, 6))
shap.plots.bar(shap_values)

```


```{python}
fig_beeswarm, ax_beeswarm = plt.subplots()
shap.plots.beeswarm(shap_values, max_display=20)

```